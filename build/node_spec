FROM alpine:3.14
ARG ARTIFACT_BIN=nolus.tar.gz
ARG CUSTOM_MONIKER=docker_generated_node
ARG ACCESS_TOKEN=${{ secrets.wiki-reader }}
# ARG ACCESS_TOKEN=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

COPY $ARTIFACT_BIN /tmp/
RUN tar -xvf /tmp/$ARTIFACT_BIN --directory /usr/bin/
RUN rm /tmp/$ARTIFACT_BIN

RUN nolusd init $CUSTOM_MONIKER
RUN wget -O genesis.json --header="Authorization: Token $ACCESS_TOKEN" https://raw.githubusercontent.com/Nolus-Protocol/Wiki/main/testnet-rila/genesis.json \
 && mv genesis.json ~/.nolus/config/genesis.json
# set persistent peers in config.toml
RUN wget -O persistent_peers.txt --header="Authorization: Token $ACCESS_TOKEN" https://raw.githubusercontent.com/Nolus-Protocol/Wiki/main/testnet-rila/persistent_peers.txt \
&& sed -i.bak -e "s~^persistent_peers *=.*~persistent_peers = \"$(cat persistent_peers.txt)\"~" ~/.nolus/config/config.toml \ 
&& rm persistent_peers.txt
# set the minimum gas price to 0.0025unls
RUN sed -i "s|0stake|0.0025unls|g" ~/.nolus/config/app.toml

VOLUME [ "~/.nolus" ]

# rest server
EXPOSE 1317
# tendermint p2p
EXPOSE 26656/tcp
# tendermint rpc
EXPOSE 26657/tcp

ENTRYPOINT ["nolusd"]
CMD ["start"]